pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- game state
state = {}

mapx = 0
mapy = 0

mapox = 0
mapoy = 0

-- consts
gridsize = 8

-- player loc
player = {}

-- consts for easier sprite lookup
index = {}

-- debug
blkmsg = 0

tick = 0

-- current block sprite positions
blocks = {}

function _init()
	state.menu = 3

	-- setup sprite consts
	index.player = 62
	index.block = 16
	index.animal = 3

	-- environment
	index.fire = 7

	index.waterblock = 17
	index.water1 = 8
	index.water2 = 9
    index.ice = 10

    if (state.menu == 3) then 
        player.x = 5
        player.y = 8
        mapx = 19
        mapy = 0
        
        mapox = 2
        mapoy = 2

    	blocks = {{2,2},{3,3},{4,4},{5,5}}

    else
        
    	player.x = 2
    	player.y = 2

	
    	-- place blocks
    	blocks = {{2,2},{3,3},{4,4},{5,5}}
    end

	for i in all(blocks) do
		mset(i[1], i[2], index.block)
	end

end

function _update()
	local dx = 0
	local dy = 0

	if (btnp(0)) then 
		dx=-1
	elseif (btnp(1)) then
		dx=1
	elseif (btnp(2)) then
		dy=-1
	elseif (btnp(3)) then
		dy=1
	end

	if (canmove(dx, dy)) then
		player.x += dx
		player.y += dy
	end
end

function _draw()
	tick+=1
	if (tick > 32) tick = 0;

	if (state.menu==0) draw_mainmenu()
	if (state.menu>=1) draw_level()

end

function draw_mainmenu() 
	cls()

	rectfill(0, 0, 127, 127, 13)



end

function draw_level()
	cls()
	
	if (tick == 0) then 
		for x=1, 16 do
			for y=1, 16 do 
				if (mget(x, y) == index.water1) then
					blkmsg = "flip"
					mset(x, y, index.water2)
				elseif(mget(x, y) == index.water2) then
					blkmsg = "flop"
					mset(x, y, index.water1)
				end
			end
		end
	end

	map(mapx, mapy, mapox*gridsize, mapoy*gridsize, 128, 128)
	
	spr(index.player, player.x*gridsize, player.y*gridsize)

	print(blkmsg)
end


function canmove(dx, dy)
	if (dx == 0 and dy == 0) return false

	local localx = player.x + dx + mapx - mapox
	local localy = player.y + dy + mapy - mapoy

	local nextx = localx + dx
	local nexty = localy + dy

	-- check the sprite this collides with to see if it's a block
	cspr = mget(localx, localy)

	-- get next sprite
	local nspr = mget(nextx, nexty)

	-- collided with block
	if (cspr == index.block) then 
		if (nspr == 0) then
			mset(localx, localy, nil)
			mset(nextx, nexty, index.block)
			return true
		elseif (nspr >= index.water1 and nspr <= index.ice) then
			mset(localx, localy, nil)
			mset(nextx, nexty, index.waterblock)
			return true
		end

		// how to represent a block over a block on water?

	end

	-- debug line
	if (cspr > 0) blkmsg = cspr

	if ((cspr == index.waterblock1) or (cspr == index.waterblock2) or (cspr == index.ice)) return true
	if (cspr == 0) return true
	return false
end


__gfx__
0000000000ccc00c44444449b3b33bb33a33333311111111aaaaaaaa8f988888ccccccccc7ccccc7ccc777cc0000000000000000000000000000000000000000
000000000cccccc09449444933bb3bb33a333a3311d11ddd7777777789afa8a8ccccccc77ccccccccc777ccc0000000000000000000000000000000000000000
00700700cc44ccc044994444b3bb3bb33aa33a331d11dd11aaaaaaaa888558857ccccc7ccccc7cccc777ccc70000000000000000000000000000000000000000
00077000cc040ccc44444444bb3b3bb333a33a331d1111117777777798a58589cccc7cccc7c7cccc777ccc770000000000000000000000000000000000000000
00077000cc444cc044499444b33b3bb333aa3a331d11d111aaaaaaaaf988fa88ccc7c7cccc7ccccc77ccc77c0000000000000000000000000000000000000000
007007000ceaeccc44444444b3bb33b333a33333111dd11d777777778558598acc7ccccccccccccc7ccc77c70000000000000000000000000000000000000000
0000000004aea4c099449994b3bbb3b333333333111d1111aaaaaaaa585af8a87ccccccccccc7c7cccc77c7c0000000000000000000000000000000000000000
0000000000aea0c094444444b3bb33bb33aaa33311111111777777778f898989c7ccccc7ccccc7cccc77c7cc0000000000000000000000000000000000000000
00000000cccccccc5444444500444bb0009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05444450c544445c454444540044bbb8009009000000000000000000000000000000000000000000000000000000000000000000000000000000000050505050
04544540c454454c4454454400bbb300009999000000000000000000000000000000000000000000000000000000000000000000000000000000000005000500
04455440c445544c444554440bb33400000900000000000000000000000000000000000000000000000000000000000000000000000000000000000050505050
04455440c445544c4445544403344400000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04544540c454454c4454454400444bb0000990000000000000000000000000000000000000000000000000000000000000000000000000000000000055555550
05444450c544445c45444454b04bbb30000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000080800
00000000cccccccc544444450bbb3300000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000088800
000000406000000600000000060060000333000203350ddd0999000000777700000004400777000044004044e000e000000220000000220000ccc00c00ccc00c
0666000460000066900909500e00e0008b830022033333d04549000007777770044400440a57007004440004eeee000020029002000022900cccccc00c666cc0
6686604066006660995900900e00e000bbb3022000000300444999007777777745f54004aa777770064640440e0e00002202202200002200cc44ccc0c66666c0
6666604006556000399309500666600000b32223003f330004999449565777770fff00040777777004f44440eeeeeeeee222222e00022220cc040cccc65656cc
0066604400550555999959900d6d666000b3223333ff000004494449666777770444404407777770044444400eeeeee00e2222e02222e220cc444cc0c66666c0
006666640555555505995990066666670bb323303000003004449449077777770044444007777700044444400eeeeee000e22e00022e22200ceaeccc0c555ccc
006666600055555509999950066666670b3b3b303300033004040049007777700044440000a7a000040400400eeeeee0000929000022220004aea4c0006660c0
0006066000d0d00d0909009006666660030303300333330004040040006000600400440000a0a000040400400e0e00e0002222000009090000aea0c0000000c0
00005500005550000000000000000b0b000000005500005500055000d09090d009990440000055353550000000eeee0000eeee000000000000eeee00000aaa00
0005599000595000002220000000bbb0000000555000055000555500dd090ddd9999904400055355535500000ee77ee00ee77ee0000000000eeefee000aaaaa0
0055550000555000205250220000bbb0005555555550555000aaaaa0edd9dded95f590040033333333333bb0ee7777eeee7777ee000000000edffde00aa0f0a0
00555700055755002222222000000b0b05585555555555000055550aded9dedd9fff90040535535535535b5b0eeeeee00eeeeee0000000000effffe00aafffa0
0055770005777500002222000000000055555555555555000055550addd9ddd009994044bb33333333333bbbe00e00e00e00e00e000000000e666ee00faeeaa0
0055770005777500022202200000bb0b076765555550555000aaaa0a00d9d00000444440000bb3333bbb00000e00e00ee00e00e0000000000ebbbbe00faeeaf0
0055570005575500220220220000bbb00055555500000550005555a0ddd9ddd0004444000bbbb00000bbb000e00e00e00e00e00e0000000000ebbe0000addd00
0005990000999000200020000000000b000000555000005500555500ed000ded04004400bbb000000bbb00000e00e00ee00e00e000000000000bb00000eeee00
00000000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000900000099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099990000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999990000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00990099000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999999000099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999999000099900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999999009999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999990999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999990099990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
00000000000000000000000000000000030303000a0a3131310a0a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02020202020202020202020202020203030303000a0a0a0a0a0a0a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020000002800002500000000000000030303030002020a0a0a02020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020034350000000000002200000000030303030002020a0a0a02140a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000270000002400002a0000030303030002020a0a0a020a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0220002b0000000000000000000000030303030002020a0a0a020a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02000000000000002100290000260003030303000a0a0a0a0a020a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02000000002300000000000000000003030303000a0a0a0a0a0a0a0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000040410303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200100008080808080808080050510303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000008080808080808081100000303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200100000070707070707070000000303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000007070707070707070000000303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200001000070707070707000011000303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
